<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>

<body>
<script>
Office.onReady(() => {
    console.log("Commands.html loaded");
});

/* =====================================================
   RIBBON ACTION
===================================================== */
async function triggerFlowFromRibbon(event) {
    try {
        Office.context.mailbox.item.notificationMessages.addAsync(
            "progress",
            {
                type: "progressIndicator",
                message: "Analyzing email and sending to workflow..."
            }
        );

        const emailData = await getEmailData();

        const flowUrl =
            "https://default74afe875305e4ab4ba4ac1359a7629.ae.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/241950e062094f60a4c73510db9c666d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=XRKBRdnjEmcVW7O2bhrVsQkfg6y8WvoDZDG89MBpN9A";
        const response = await fetch(flowUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(emailData)
        });

        Office.context.mailbox.item.notificationMessages.removeAsync("progress");

        if (!response.ok) {
            const err = await response.text();
            throw new Error(`HTTP ${response.status}: ${err}`);
        }

        Office.context.mailbox.item.notificationMessages.addAsync(
            "success",
            {
                type: "informationalMessage",
                message: "Email processed successfully âœ“",
                icon: "Icon.16x16",
                persistent: true
            }
        );

    } catch (error) {
        console.error(error);

        Office.context.mailbox.item.notificationMessages.removeAsync("progress");

        Office.context.mailbox.item.notificationMessages.addAsync(
            "error",
            {
                type: "errorMessage",
                message: "Processing failed. Please try again! "
            }
        );
        console.log("Error Message: " + error.message)
    } finally {
        event.completed();
    }
}

/* =====================================================
   EMAIL DATA COLLECTION
===================================================== */
async function getEmailData() {
    const item = Office.context.mailbox.item;

    if (!item) throw new Error("No email context");

    const subject = await getSubject(item);
    const body = await getBody(item);
    const attachments = await getAttachmentContents(item);

    return {
        triggeredAt: new Date().toISOString(),

        userEmail: Office.context.mailbox.userProfile.emailAddress || "",

        subject: subject,
        body: body,

        from: getSender(item),

        receivedDateTime:
            item.dateTimeCreated ||
            item.dateTimeModified ||
            new Date().toISOString(),

        internetMessageId: item.internetMessageId || "",

        hasAttachments: attachments.length > 0,
        attachmentCount: attachments.length,
        attachments: attachments
    };
}

/* =====================================================
   HELPERS
===================================================== */
function getSubject(item) {
    return new Promise(resolve => {
        if (typeof item.subject === "string") {
            resolve(item.subject);
        } else {
            item.subject.getAsync(result =>
                resolve(result.status === Office.AsyncResultStatus.Succeeded
                    ? result.value
                    : "Subject unavailable")
            );
        }
    });
}

function getBody(item) {
    return new Promise(resolve => {
        item.body.getAsync(Office.CoercionType.Text, result =>
            resolve(result.status === Office.AsyncResultStatus.Succeeded
                ? result.value
                : "Body unavailable")
        );
    });
}

function getSender(item) {
    if (!item.from) return "Unknown";

    if (typeof item.from === "string") return item.from;
    if (item.from.emailAddress) return item.from.emailAddress;
    if (item.from.displayName) return item.from.displayName;

    return "Unknown";
}

/* =====================================================
   ATTACHMENT CONTENT (BASE64)
===================================================== */
async function getAttachmentContents(item) {
    if (!item.attachments || item.attachments.length === 0) {
        return [];
    }

    const results = [];

    for (const att of item.attachments) {
        await new Promise(resolve => {
            item.getAttachmentContentAsync(att.id, res => {
                if (res.status === Office.AsyncResultStatus.Succeeded) {
                    results.push({
                        id: att.id,
                        name: att.name,
                        contentType: att.contentType,
                        size: att.size,
                        content: res.value.content,   // Base64
                        format: res.value.format
                    });
                } else {
                    results.push({
                        id: att.id,
                        name: att.name,
                        error: res.error.message
                    });
                }
                resolve();
            });
        });
    }

    return results;
}

/* =====================================================
   REGISTER COMMAND
===================================================== */
Office.actions.associate("triggerFlowFromRibbon", triggerFlowFromRibbon);
</script>
</body>
</html>
